---
description: KSP processor test conventions for ktnip
globs: "**/ktnip/**/*Test*.kt", "**/ktnip/**/jvmTest/**/*.kt"
alwaysApply: false
---

# KSP Processor Test Rules

## Test Base

- Extend **AbstractKspTest**
- Kotest AnnotationSpec with `@Test`

```kotlin
class ProcessorTest : AbstractKspTest() {
    @Test
    fun defaultHandlers() = runTest("test-data/DefaultHandlers.kt")
}
```

## runTest vs compile

- **runTest(path)**: Load from `jvmTest/resources/test-data/<name>.kt`, compile with ActivityProcessorProvider, assert exitCode OK, verify generated files (ActivitiesData.kt, KtGramCtxLoader.kt, BotCtx.kt)
- **compile(vararg SourceFile)**: Inline sources, custom processors; returns JvmCompilationResult for custom assertions

## Golden Output in Comments

- Add `// @generated <filename>: substring1, substring2` to test data for partial inclusion checks
- Supports ActivitiesData.kt, KtGramCtxLoader.kt, BotCtx.kt
- Multi-line: `// @generated BotCtx.kt:` followed by `//   substring` lines

## Test Data

- Place in `ktnip/src/jvmTest/resources/test-data/`
- Must import from telegram-bot (project dependency)
- Use non-default annotation params (Guard, ArgParser, scope, etc.) where relevant
- Examples: DefaultHandlers.kt, WizardHandlers.kt, Injectables.kt, CtxProviders.kt

## Verification

- `./gradlew :ktnip:jvmTest` runs all KSP tests
- prepareRelease includes ktnip:jvmTest
