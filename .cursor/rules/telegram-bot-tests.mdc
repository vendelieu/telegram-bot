---
description: Test conventions for Telegram Bot library
globs: "**/*Test*.kt", "**/jvmTest/**/*.kt"
alwaysApply: false
---

# Telegram Bot Test Rules

## Test Base

- Extend **BotTestContext** (provides `bot`, `TG_ID`, `CHAT_ID`, `CHANNEL_ID`)
- Use Kotest **AnnotationSpec** with `@Test` for suspend tests

```kotlin
class MyApiTest : BotTestContext() {
    @Test
    suspend fun `descriptive test name`() {
        // ...
    }
}
```

## API Call Helpers

- **Action**: `action.sendReq(to = TG_ID, via = bot)` or `action.sendReq(CHAT_ID)`
- **SimpleAction**: `action.sendReq(via = bot)` or `action.sendReq()`
- **MediaAction**: same as Action
- `sendReq()` returns `Response<T>`; use `sendReturning()` when you need `Deferred`

## Assertions

- Success: `.shouldSuccess()` - asserts ok, isSuccess, getOrNull not null
- Failure: `.shouldFailure()` - returns `Response.Failure`
- Optional result: `.getOrNull()` when success is not guaranteed
- Error text: `response.shouldFailure() shouldContainInDescription "ERROR_TEXT"`

## Rate Limits

Handle 429 with `onFailure`:

```kotlin
val result = setMyName("test").sendReq()
result.onFailure { if (it.errorCode == 429) return }
result.shouldSuccess()
```

## Environment

Tests load from `.env` or system env: `TELEGRAM_ID`, `BOT_TOKEN`, `CHAT_ID`, `CHANNEL_ID`, `BOT_TOKEN_2`, `PAYMENT_PROVIDER_TOKEN`
